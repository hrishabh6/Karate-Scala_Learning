name: CD - Load Testing (Gatling) [MANUAL]

on:
  workflow_dispatch:

jobs:
  load-test:
    runs-on: self-hosted

    steps:
      - name: Setup SSH for Load VM
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/load_vm_key
          chmod 600 ~/.ssh/load_vm_key
          ssh-keyscan -H ${{ secrets.LOAD_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Run Gatling Load Test on Load VM and Zip Latest Report
        run: |
          ssh -i ~/.ssh/load_vm_key ${{ secrets.LOAD_VM_USER }}@${{ secrets.LOAD_SERVER_IP }} << 'EOF'
            set -e

            echo "ðŸ“¦ Syncing repository on Load VM"
            if [ ! -d "springboot-load" ]; then
              git clone https://github.com/hrishabh6/karate-scala_learning.git springboot-load
            fi

            cd springboot-load

            echo "ðŸ§¹ Forcing clean Git state (CI-safe)"
            git reset --hard
            git clean -fd

            echo "ðŸ“¥ Pulling latest code"
            git pull origin main

            echo "ðŸš€ Running Gatling Load Test..."
            mvn -B -Dgatling.skip=false gatling:test -DbaseUrl=http://${VM_HOST}:8080

            echo "ðŸ“¦ Locating latest Gatling report..."
            LATEST_RUN_DIR=$(ls -td target/gatling/* | head -1)

            TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
            REPORT_NAME="gatling-report-$TIMESTAMP.zip"

            echo "âœ… Latest report directory: $LATEST_RUN_DIR"
            echo "âœ… Report name: $REPORT_NAME"

            zip -r "$REPORT_NAME" "$LATEST_RUN_DIR"

            echo "âœ… Zipped report created: $REPORT_NAME"
          EOF
        env:
          VM_HOST: ${{ secrets.VM_HOST }}

      - name: Copy Gatling Report from Load VM
        run: |
          scp -i ~/.ssh/load_vm_key \
            ${{ secrets.LOAD_VM_USER }}@${{ secrets.LOAD_SERVER_IP }}:~/springboot-load/gatling-report-*.zip \
            .

      - name: Upload Gatling HTML Report to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: gatling-html-report-${{ github.run_number }}
          path: gatling-report-*.zip
