name: CD - Load Testing (Gatling) [MANUAL]

on:
  workflow_dispatch:

jobs:
  load-test:
    runs-on: self-hosted

    steps:
      - name: Setup SSH for Load VM
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VM_SSH_KEY }}" > ~/.ssh/load_vm_key
          chmod 600 ~/.ssh/load_vm_key
          ssh-keyscan -H ${{ secrets.LOAD_SERVER_IP }} >> ~/.ssh/known_hosts

      - name: Run Gatling Load Test on Load VM
        run: |
          ssh -i ~/.ssh/load_vm_key ${{ secrets.LOAD_VM_USER }}@${{ secrets.LOAD_SERVER_IP }} << EOF
            set -e

            echo "ðŸ“¦ Syncing repository on Load VM"
            if [ ! -d "springboot-load" ]; then
              git clone https://github.com/hrishabh6/karate-scala_learning.git springboot-load
            fi

            cd springboot-load
            git pull origin main

            echo "ðŸš€ Running Gatling Load Test..."
            mvn -B gatling:test -DbaseUrl=http://${{ secrets.VM_HOST }}:8080

            echo "ðŸ“¦ Zipping Gatling reports..."
            cd target
            zip -r gatling-report.zip gatling
          EOF

      - name: Copy Gatling Report from Load VM
        run: |
          scp -i ~/.ssh/load_vm_key \
            ${{ secrets.LOAD_VM_USER }}@${{ secrets.LOAD_SERVER_IP }}:~/springboot-load/target/gatling-report.zip \
            gatling-report.zip

      - name: Upload Gatling HTML Report to GitHub
        uses: actions/upload-artifact@v4
        with:
          name: gatling-html-report
          path: gatling-report.zip
